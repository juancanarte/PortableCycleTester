{% load static %}
<div class="container">
    <div class="row justify-content-center align-items-center">
      <div class="col-sm">
        <h3 class="subtitulo">CAFE - {{modo_cafe_1}}</h3>
      </div>
    </div>
</div>

<div class="container">
    <div class="row justify-content-center align-items-center">
      <div class="col-sm">

        <div class="computer_text_main" style="margin-top: 10px;">
            <h2>Parameters</h2>
            <div id="divShowParamsCafe_1">
                <button id="showParamsCafe_1" class="css-button-eye" onclick="showParams_1()">
                    <img src="{% static 'images/eye.svg' %}" alt="Icono">
                </button>
            </div>
            <div id="divHideParamsCafe_1" hidden>
                <button id="hideParamsCafe_1" class="css-button-eye" onclick="hideParams_1()">
                    <img src="{% static 'images/eye-off.svg' %}" alt="Icono">
                </button>
            </div>
        </div>

        <div id="divParamsCafe_1" class="computer_text_main flex-column" style="margin-top: 10px; margin-bottom: 10px; width: 205px;" hidden>
            <table style="width: 100%;">
              <tr>
                <th>Config.</th>
                <th>Option</th>
              </tr>
              <tr>
                <td>Oper. Mode :</td>
                <td id="OpModeCafe_1">{{modo_cafe_1}}</td>
              </tr>
              <tr id="OpVoltCafe_1">
                <td>Op. Voltage :</td>
                <td>{{opVoltage_cafe_1}}</td>
              </tr>
              <tr id="InputCafe_1">
                <td>Input Type :</td>
                <td>{{inputSignal_cafe_1}}</td>
              </tr>
              <tr id="BaudCafe_1">
                <td>Baud :</td>
                <td>{{baud_cafe_1}}</td>
              </tr>
              <tr id="NodeCafe_1">
                <td>Node :</td>
                <td>{{node_cafe_1}}</td>
              </tr>
              <tr id="SignalCafe_1">
                <td>Signal Type :</td>
                <td>{{signalType_cafe_1}}</td>
              </tr>
              <tr id="WidthCafe_1">
                <td>Pulse width :</td>
                <td>{{widthTime_cafe_1}}</td>
              </tr>
            </table>
        </div>

        <div class="computer_text_main" style="width: 100%;">
          <canvas id="myChart_1" style="width: 100%;"></canvas>
        </div>

        <div class="row justify-content-center align-items-center">
            <div class="computer_text_main" style="border: 2px dashed #000; padding: 5px; max-width: 540px;">
                <div class="computer_text_main">
                    <h3>Test of time :</h3>
                </div>

                <div class="computer_text_main">
                    <h3 id="open_cafe_1">Open : </h3>
                    
                </div>

                <div class="computer_text_main">
                    <h3 id="close_cafe_1">Close : </h3>
                    
                </div>
            </div>

            <div class="computer_text_main" style="padding: 5px;">
                <h3>Total Test Time :</h3>
                <h1 id="testTime_1"></h1>
            </div>
        </div>

        <div class="computer_text_main" style="padding: 5px; max-width: 540px;">
          <button id="powerOn_Cafe_1" class="css-button-eye" style="margin-right: 10px; border-radius: 0%; min-width:80px;" onclick="powerOn_Cafe_1()">
            ON
            <img src="{% static 'images/on.svg' %}" alt="Icono">
          </button> 
    
          <button id="powerOff_Cafe_1" class="css-button-eye" style="margin-right: 10px; border-radius: 0%; min-width:80px;" onclick="window.modalTurnOff_cafe_1.showModal();" hidden>
            OFF
            <img src="{% static 'images/off.svg' %}" alt="Icono">
          </button>
        </div>

        <div id="divButtons_cafe_1" class="computer_text_main" style="margin-top: 10px;" hidden>
            <div id="divStart_1">
                <button id="bStart_1" class="css-button-show" onclick="start_1()">Start</button>
            </div>
            <div id="divStop_1">
                <button id="bStop_1" class="css-button-show">Stop</button>
            </div>
            <div id="divPause_1">
                <button id="bPause_1" class="css-button-show">Pause</button>
            </div>
            <div id="divReset_1">
                <button id="bResume_1" class="css-button-show">Resume</button>
            </div>
        </div>

      </div>
    </div>
</div>

<!-- Modal -->
<dialog id="modalTurnOff_cafe_1">
  <h2>Turn OFF device?</h2>
  <br>
  <button class="css-button-eye" style="margin-right: 10px; border-radius: 0%; width:80px;" onclick="powerOff_Cafe_1()">
    Ok
  </button>
  <button class="css-button-eye" style="margin-right: 10px; border-radius: 0%; width:80px;" onclick="window.modalTurnOff_cafe_1.close();">
    Cancel
  </button>
</dialog>

<!-- Modal turn on waiting -->
<dialog id="modalTurnON_waiting_cafe_1">
  <h2>Turning ON CAFE ...</h2>
  <progress style="width: 100%; height: 20px;" id="progressBarTurnOn_cafe_1" max="100" value="0"></progress>
  <br>
</dialog>

<!-- Modal go to 0% -->
<dialog id="modalGoTo_0_cafe_1">
  <h2>Going to position 0% ...</h2>
  <progress style="width: 100%; height: 20px;" id="progressBarGoTo0_cafe_1" max="100" value="0"></progress>
  <br>
</dialog>

<script src="{% static 'js/chart.min.js' %}"></script>
<script>
const modalTurnON_waiting_cafe_1 = document.getElementById("modalTurnON_waiting_cafe_1");
const progressBarTurnOn_cafe_1 = document.getElementById("progressBarTurnOn_cafe_1");

const modalGoTo_0_cafe_1 = document.getElementById("modalGoTo_0_cafe_1");
const progressBarGoTo0_cafe_1 = document.getElementById("progressBarGoTo0_cafe_1");

    var divShowParamsCafe_1 = document.getElementById('divShowParamsCafe_1');
    var divHideParamsCafe_1 = document.getElementById('divHideParamsCafe_1');
    var divParamsCafe_1 = document.getElementById('divParamsCafe_1');
    var divButtons_cafe_1 = document.getElementById('divButtons_cafe_1')
    //const bStart_a = document.getElementById('bStart_a');
    const stopButton_1 = document.getElementById('bStop_1');
    const bPause_1 = document.getElementById('bPause_1');
    const bResume_1 = document.getElementById('bResume_1');

    const bPowerOn_Cafe_1 = document.getElementById('powerOn_Cafe_1');
    const bPowerOff_Cafe_1 = document.getElementById('powerOff_Cafe_1');

    var InputCafe_1 = document.getElementById('InputCafe_1');
    var OpModeCafe_1 = document.getElementById('OpModeCafe_1');
    var BaudCafe_1 = document.getElementById('BaudCafe_1');
    var NodeCafe_1 = document.getElementById('NodeCafe_1');

    if (OpModeCafe_1.textContent != "modbus")
    {
      BaudCafe_1.setAttribute("hidden", "hidden");
      NodeCafe_1.setAttribute("hidden", "hidden");
    }
    else
    {
      BaudCafe_1.removeAttribute("hidden");
      NodeCafe_1.removeAttribute("hidden");
    }

    if (OpModeCafe_1.textContent != "modulation")
    {
      InputCafe_1.setAttribute("hidden", "hidden");
    }
    else
    {
      InputCafe_1.removeAttribute("hidden");
    }
    
   /* bStart_a.addEventListener('click', function() {
            startWrite();
            console.log('start');
        });*/

    stopButton_1.addEventListener('click', function() {
            socket_1.close(); // Cierra la conexión WebSocket
        });

    bPause_1.addEventListener('click', function() {
            pause_1();
            pause_ws_1();
        });

    bResume_1.addEventListener('click', function() {
            resume_1();
            resume_ws_1();
        });

    var socket_1 = null;

  socket_1 = new WebSocket("ws://" + window.location.host + "/ws/ct_read_cafe_1/");
  socket_1.onmessage = function(event){
    var data1 = JSON.parse(event.data);

    document.querySelector('#open_cafe_1').innerText = "Open : " + data1.relayCountA;
    document.querySelector('#close_cafe_1').innerText = "Close : " + data1.relayCountB;
    document.querySelector('#testTime_1').innerText = data1.min + ":" + data1.sec;

    myLineChart_1.data.datasets[0].data.splice(0, 1);
    myLineChart_1.data.datasets[0].data.push(data1.pos);
    
    myLineChart_1.data.datasets[1].data.splice(0, 1);
    myLineChart_1.data.datasets[1].data.push(data1.setPos);

    myLineChart_1.data.datasets[2].data.splice(0, 1);
    myLineChart_1.data.datasets[2].data.push(data1.relay_O);

    myLineChart_1.data.datasets[3].data.splice(0, 1);
    myLineChart_1.data.datasets[3].data.push(data1.relay_C);
    myLineChart_1.update();
  }

  function powerOn_Cafe_1() {
    turnOn_1();
    //intervalId_1 = setInterval(readToCafe_1, 200);

    window.modalTurnON_waiting_cafe_1.showModal();
    let progress = 0;
    const interval = setInterval(function() {
    progress += 1;
    progressBarTurnOn_cafe_1.value = progress;
    if (progress >= 100) {
      clearInterval(interval);
      setTimeout(function() {
        modalTurnON_waiting_cafe_1.close();
        progressBarTurnOn_cafe_1.value = 0;
        modalGoTo_0_cafe_1.showModal();

        let progressSecond = 0;
        const intervalSecond = setInterval(function() {
          progressSecond += 0.35;
          progressBarGoTo0_cafe_1.value = progressSecond;
          if (progressSecond >= 100) {
            clearInterval(intervalSecond);
            setTimeout(function() {
              modalGoTo_0_cafe_1.close(); // Cerrar el segundo modal después de 2 segundos
              progressBarGoTo0_cafe_1.value = 0;
            }, 50); // Cerrar el segundo modal después de 2 segundos
          }
        }, 20);

      }, 10); // Cerrar el modal después de 2 segundos
    }
    }, 20); // Actualizar la barra de progreso cada 20ms

    bPowerOn_Cafe_1.setAttribute("hidden", "hidden");
    bPowerOff_Cafe_1.removeAttribute("hidden");
    divButtons_cafe_1.removeAttribute("hidden");
  }

  function powerOff_Cafe_1() {
    window.modalTurnOff_cafe_1.close();
    window.modalGoTo_0_cafe_1.showModal();
    socket_1.send(JSON.stringify({'message':'stop'}))

    let progress = 0;
    const interval = setInterval(function() {
    progress += 0.35;
    progressBarGoTo0_cafe_1.value = progress;
    if (progress >= 100) {
      clearInterval(interval);
      setTimeout(function() {
        modalGoTo_0_cafe_1.close();
        progressBarGoTo0_cafe_1.value = 0;

      }, 10); // Cerrar el modal después de 2 segundos
    }
    }, 20); // Actualizar la barra de progreso cada 20ms

    turnOff_1();
    bPowerOff_Cafe_1.setAttribute("hidden", "hidden");
    bPowerOn_Cafe_1.removeAttribute("hidden");
    divButtons_cafe_1.setAttribute("hidden", "hidden");
  }
  // Detener el consumidor
function startWrite_1() {
  socket_1.send(JSON.stringify({
    'message':'start'
  }))
}

function pause_ws_1() {
  socket_1.send(JSON.stringify({
    'message':'pause'
  }))
}

function resume_ws_1() {
  socket_1.send(JSON.stringify({
    'message':'resume'
  }))
}

    function showParams_1() {
        /*$.ajax({
            url: '/show_start_cafe_alone/',
            success: function (data) {
            }
        });*/
        divParamsCafe_1.removeAttribute("hidden");
        divShowParamsCafe_1.setAttribute("hidden", "hidden");
        divHideParamsCafe_1.removeAttribute("hidden");
    }

    function hideParams_1() {
        /*$.ajax({
            url: '/show_start_cafe_alone/',
            success: function (data) {
            }
        });*/
        divParamsCafe_1.setAttribute("hidden", "hidden");
        divHideParamsCafe_1.setAttribute("hidden", "hidden");
        divShowParamsCafe_1.removeAttribute("hidden");
    }

var numeros_1 = []; // Declarar un arreglo vacío
var arreglo_1 = Array(100).fill(0);
var arreglo2_1 = Array(100).fill(0);
var arreglo3_1 = Array(100).fill(0);
var arreglo4_1 = Array(100).fill(0);

for (var i = 0; i <= 100; i++) {
numeros_1.push(i.toString()); // Convertir el número a string y agregarlo al arreglo
}

var canvas_1 = document.getElementById('myChart_1');
var data_1 = {
labels: numeros_1,
datasets: [
{
  label: "Control Signal",
  fill: false,
  lineTension: 0.0,
  backgroundColor: "rgba(255,166,0,1)",
  borderColor: "rgba(255,166,0,1)",
  borderCapStyle: 'butt',
  borderDash: [],
  borderDashOffset: 0.0,
  borderJoinStyle: 'miter',
  pointBorderColor: "rgba(75,192,192,1)",
  pointBackgroundColor: "#fff",
  pointBorderWidth: 1,
  pointHoverRadius: 1,
  pointHoverBackgroundColor: "rgba(75,192,192,1)",
  pointHoverBorderColor: "rgba(220,220,220,1)",
  pointHoverBorderWidth: 2,
  pointRadius: 0,
  pointHitRadius: 10,
  data: arreglo_1,
},
{
  label: "Feedback Signal",
  fill: false,
  lineTension: 0.0,
  backgroundColor: "rgba(0,0,255,1)",
  borderColor: "rgba(0,0,255,1)",
  borderCapStyle: 'butt',
  borderDash: [],
  borderDashOffset: 0.0,
  borderJoinStyle: 'miter',
  pointBorderColor: "rgba(75,12,192,1)",
  pointBackgroundColor: "#fff",
  pointBorderWidth: 1,
  pointHoverRadius: 1,
  pointHoverBackgroundColor: "rgba(75,12,192,1)",
  pointHoverBorderColor: "rgba(220,20,220,1)",
  pointHoverBorderWidth: 2,
  pointRadius: 0,
  pointHitRadius: 10,
  data: arreglo2_1,
},
{
  label: "Relays 100%",
  fill: false,
  lineTension: 0.0,
  backgroundColor: "rgba(0,255,0,1)",
  borderColor: "rgba(0,255,0,1)",
  borderCapStyle: 'butt',
  borderDash: [],
  borderDashOffset: 0.0,
  borderJoinStyle: 'miter',
  pointBorderColor: "rgba(75,12,192,1)",
  pointBackgroundColor: "#fff",
  pointBorderWidth: 1,
  pointHoverRadius: 1,
  pointHoverBackgroundColor: "rgba(75,12,192,1)",
  pointHoverBorderColor: "rgba(220,20,220,1)",
  pointHoverBorderWidth: 2,
  pointRadius: 0,
  pointHitRadius: 10,
  data: arreglo3_1,
},
{
  label: "Relays 0%",
  fill: false,
  lineTension: 0.0,
  backgroundColor: "rgba(250,0,0,1)",
  borderColor: "rgba(250,0,0,1)",
  borderCapStyle: 'butt',
  borderDash: [],
  borderDashOffset: 0.0,
  borderJoinStyle: 'miter',
  pointBorderColor: "rgba(75,12,192,1)",
  pointBackgroundColor: "#fff",
  pointBorderWidth: 1,
  pointHoverRadius: 1,
  pointHoverBackgroundColor: "rgba(75,12,192,1)",
  pointHoverBorderColor: "rgba(220,20,220,1)",
  pointHoverBorderWidth: 2,
  pointRadius: 0,
  pointHitRadius: 10,
  data: arreglo4_1,
}
]
};

var option_1 = {
animation: true,
responsive: true,
scales: {
        y: {
            suggestedMin: 0,
            suggestedMax: 100
        },
        x: {
            suggestedMin: 0,
            suggestedMax: 100,
            ticks:{
                minTicksLimit: 1000,
                maxTicksLimit: 1000,
                sampleSize:500,
            }
        }
    }
};

var myLineChart_1 = new Chart(canvas_1, {
type: 'line',
data: data_1,
options: option_1
});

function turnOn_1() {
        $.ajax({
            url: '/ct/cycleTest_turnOn_cafe_1/',
            success: function (data) {
            }
        });
    }

  function turnOff_1() {
        $.ajax({
            url: '/ct/cycleTest_turnOff_cafe_1/',
            success: function (data) {
            }
        });
    }

function start_1() {
        $.ajax({
            url: '/ct/cycleTest_start_cafe_1/',
            success: function (data) {
            }
        });
        startWrite_1();
    }
function stop_1() {
    detenerConexion_1();
    //socket.close();
    }

function pause_1() {
        $.ajax({
            url: '/ct/cycleTest_pause_cafe_1/',
            success: function (data) {
            }
        });
    }

function resume_1() {
        $.ajax({
            url: '/ct/cycleTest_resume_cafe_1/',
            success: function (data) {
            }
        });
    }
</script>